
-- ############################################################
-- FILE: data_setup.sql
-- PURPOSE: Clean and transform Netflix dataset for analysis
-- AUTHOR: Mihret Ayalkbet
-- DATE: 2025-09-26
-- ############################################################

-- Drop the table if it already exists
DROP TABLE IF EXISTS netflix_cleaned;

-- Create a cleaned Netflix table
CREATE TABLE netflix_cleaned AS
SELECT
    Title,
    Type,
    COALESCE(Director, 'Unknown') AS Director,
    COALESCE(Cast, 'Unknown') AS Cast,
    COALESCE(Country, 'Unknown') AS Country,
    COALESCE(
        CASE 
            WHEN Rating IS NULL THEN 'Unknown'
            ELSE UPPER(TRIM(REPLACE(Rating, ' ', '-')))
        END,
        'Unknown'
    ) AS Rating,
    CAST(Date_Added AS DATE) AS Date_Added,
    EXTRACT(YEAR FROM CAST(Date_Added AS DATE)) AS Year_Added,
    Release_Year,
    Genre,
    CASE 
        WHEN Duration LIKE '%Season%' THEN CAST(SUBSTRING(Duration FROM '([0-9]+)') AS INT)
        WHEN Duration LIKE '%min%' THEN CAST(SUBSTRING(Duration FROM '([0-9]+)') AS INT)
        ELSE NULL
    END AS Duration_Number,
    CASE
        WHEN Duration LIKE '%Season%' THEN 'Seasons'
        WHEN Duration LIKE '%min%' THEN 'Minutes'
        ELSE NULL
    END AS Duration_Type
FROM netflix_raw
GROUP BY 
    Title, Type, Director, Cast, Country, Rating, Date_Added, Year_Added, Release_Year, Genre, Duration_Number, Duration_Type
ORDER BY Date_Added DESC;
